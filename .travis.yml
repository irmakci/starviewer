language: cpp

matrix:
  include:
    # Linux (gcc)
    - os: linux
      dist: trusty
      sudo: required
      services: docker
      compiler: gcc

      install:
        - docker build -t ubuntu - < Dockerfile

      script:
        - docker run --rm -v $(pwd):/starviewer -e CC -e CXX ubuntu bash -c ". /opt/qt56/bin/qt56-env.sh && qmake"
        - docker run --rm -v $(pwd):/starviewer -e CC -e CXX ubuntu bash -c ". /opt/qt56/bin/qt56-env.sh && make -j3"
        - docker run --rm -v $(pwd):/starviewer -e TRAVIS_OS_NAME -w /starviewer/starviewer/tests/auto ubuntu
            bash -c ". /opt/qt56/bin/qt56-env.sh && sh -c 'xvfb-run -s \"-screen 0 640x480x24\" ./autotests -silent'"

    # Linux (clang)
    - os: linux
      dist: trusty
      sudo: required
      services: docker
      compiler: clang

      install:
        - docker build -t ubuntu - < Dockerfile

      script:
        - docker run --rm -v $(pwd):/starviewer -e CC -e CXX ubuntu bash -c ". /opt/qt56/bin/qt56-env.sh && qmake -spec linux-clang"
        - docker run --rm -v $(pwd):/starviewer -e CC -e CXX ubuntu bash -c ". /opt/qt56/bin/qt56-env.sh && make -j3"
        - docker run --rm -v $(pwd):/starviewer -e TRAVIS_OS_NAME -w /starviewer/starviewer/tests/auto ubuntu
            bash -c ". /opt/qt56/bin/qt56-env.sh && sh -c 'xvfb-run -s \"-screen 0 640x480x24\" ./autotests -silent'"

    # Mac (clang)
    - os: osx
      osx_image: xcode8.3
      compiler: clang
      env:
      - SDK_INSTALL_PREFIX="$HOME/uroot/usr/local"
      - DYLD_LIBRARY_PATH="$SDK_INSTALL_PREFIX/lib"
      - DYLD_FRAMEWORK_PATH="/usr/local/opt/qt5/lib"

      before_install:
        - brew update > /dev/null
        - echo "Install Qt 5.6."
        - cp qt5.rb $(brew --prefix)/Homebrew/Library/Taps/homebrew/homebrew-core/Formula
        - brew install qt5
        - chmod -R 755 /usr/local/opt/qt5/*

      install:
        - QTDIR="/usr/local/opt/qt5"
        - PATH="$QTDIR/bin:$PATH"
        - LDFLAGS=-L$QTDIR/lib
        - CPPFLAGS=-I$QTDIR/include
        - wget -nv --directory-prefix=$HOME http://trueta.udg.edu/apt/macosx/devel/0.14/starviewer-sdk-macosx-0.14-4.tar.xz
        - mkdir ~/uroot
        - tar xf ~/starviewer-sdk-macosx-0.14-4.tar.xz -C ~/uroot

      script:
        - cd starviewer
        - qmake
        - make -j3 | sed 's/\/Applications\/Xcode\.app\/Contents\/Developer/[xcode]/g' | sed -E 's/\/(Users|home)\/travis\/uroot/[uroot]/g'
        - cd tests/auto
        - ./autotests -silent
